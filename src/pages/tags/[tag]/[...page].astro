---
import type { GetStaticPaths } from "astro";
import PageHeader from "~/components/PageHeader.astro";
import Pagination from "~/components/Pagination.astro";
import PostPreview from "~/components/PostPreview.astro";
import Layout from "~/layouts/Layout.astro";
import siteConfig from "~/site.config";
import { getSortedPosts, TagsGroup } from "~/utils";

// Note: Pagination like '/', '/2', '/3' only works with spread param like [...page]
export const getStaticPaths = (async ({ paginate }) => {
	const tagsGroup = await TagsGroup.build();
	const pages = tagsGroup.collations.flatMap((tags) => {
		// Use flatMap to lift the posts for each tag into a single array
		return paginate(tags.entries.reverse(), {
			props: { tagTitle: tags.title },
			params: { tag: tags.titleSlug },
			pageSize: siteConfig.pageSize,
		});
	});
	return pages;
}) satisfies GetStaticPaths;

const { page, tagTitle } = Astro.props;
const pageTitle =
	`Tag: ${tagTitle}` +
	(page.currentPage > 1 ? ` - Page ${page.currentPage}` : "");
const sortedPosts = await getSortedPosts();
---

<Layout title={pageTitle} description={`All posts tagged with ${tagTitle}`}>
  <div class="mt-2 sm:mt-0">
    <PageHeader titlePieces={['tags', tagTitle]} />
    {
      page.data.map((post) => {
        return (
          <PostPreview post={post} />
        )
      })
    }
    <Pagination
      prevLink={page.url.prev ? encodeURI(page.url.prev) : undefined}
      prevText="Newer Posts"
      nextLink={page.url.next ? encodeURI(page.url.next) : undefined}
      nextText="Older Posts"
    />
  </div>
</Layout>
